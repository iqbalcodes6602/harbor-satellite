name: Test Pipeline

on:
  push:
    branches: [main]
  pull_request:
    paths-ignore:
      - "*.md"
      - "assets/**"

jobs:
  vulnerability-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Dagger Version
        uses: sagikazarmark/dagger-version-action@v0.0.1

      - name: Run Vulnerability Check
        uses: dagger/dagger-for-github@v7
        with:
          version: ${{ steps.dagger_version.outputs.version }}
          verb: call
          args: vulnerability-check-report export --path=vulnerability-check.report

      - name: Generate vulnerability summary
        run: |
          echo "<h2> ðŸ”’ Vulnerability Check Results</h2>" >> $GITHUB_STEP_SUMMARY
          cat vulnerability-check.report >> $GITHUB_STEP_SUMMARY
          # Check if the lint report contains any content (error or issues)
          if ! grep -q "No vulnerabilities found." vulnerability-check.report; then
              # If the file contains content, output an error message and exit with code 1
              echo "âš ï¸ vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
              # temporarrily disabled vuln check
              exit 0
          fi

  test-code:
    name: Unit Tests (Satellite + Ground Control)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Dagger Version
        uses: sagikazarmark/dagger-version-action@v0.0.1

      # Run tests and export structured JSON report
      - name: Run Unit Tests
        uses: dagger/dagger-for-github@v7
        with:
          version: ${{ steps.dagger_version.outputs.version }}
          verb: call
          args: test-report --source=. export --path=TestReport.json

      # Render test UI in PR checks
      - name: Summarize Tests
        uses: robherley/go-test-action@v0.6.0
        with:
          fromJSONFile: TestReport.json

      # Optional: coverage (PR only)
      - name: Generate Coverage Report
        if: github.event_name == 'pull_request'
        uses: dagger/dagger-for-github@v7
        with:
          version: ${{ steps.dagger_version.outputs.version }}
          verb: call
          args: test-coverage-report --source=. export --path=coverage-report.md

      - name: Add coverage summary
        if: github.event_name == 'pull_request'
        run: cat coverage-report.md >> $GITHUB_STEP_SUMMARY

  test-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Dagger Version
        uses: sagikazarmark/dagger-version-action@v0.0.1

      - name: Test Release
        uses: dagger/dagger-for-github@v7
        with:
          version: ${{ steps.dagger_version.outputs.version }}
          verb: call
          args: snapshot-release

  build-satellite:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build the binary for the satellite
        uses: dagger/dagger-for-github@v7
        with:
          version: ${{ steps.dagger_version.outputs.version }}
          verb: call
          args: build --component=satellite

  build-ground-control:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build the binary for ground control
        uses: dagger/dagger-for-github@v7
        with:
          version: ${{ steps.dagger_version.outputs.version }}
          verb: call
          args: build --component=ground-control
  
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Dagger Version
        uses: sagikazarmark/dagger-version-action@v0.0.1

      - name: Test E2E satellite
        uses: dagger/dagger-for-github@v7
        with:
          version: ${{ steps.dagger_version.outputs.version }}
          verb: call
          args: test-end-to-end

  e2e-spiffe-join-token-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Dagger Version
        uses: sagikazarmark/dagger-version-action@v0.0.1

      - name: Test SPIFFE Join Token E2E
        uses: dagger/dagger-for-github@v7
        with:
          version: ${{ steps.dagger_version.outputs.version }}
          verb: call
          args: test-spiffe-join-token-e-2-e
